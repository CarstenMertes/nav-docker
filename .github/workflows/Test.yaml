name: Azure test

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
    build-and-deploy:
      runs-on: windows-latest
      steps:

        # Checkout code
      - uses: actions/checkout@main

        # Log into Azure
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true 

      - name: Run Azure PowerShell script
        uses: azure/powershell@v1
        with:
          azPSVersion: "latest"
          inlineScript: |
            $resGroup = "buildgeneric"
            $resLocation = "West Europe"
            $repo = "microsoft/nav-docker"
            $removeResGroupIfExist = $true
            $machines = 2
            $offset = 0
            Write-Host $resGroup
            Write-Host "-------------------------------------------------------"
            Get-Module | out-host
            Write-Host "-------------------------------------------------------"
            Get-Module -listavailable | out-host
            Write-Host "-------------------------------------------------------"
            $runners = (gh api /repos/$repo/actions/runners | ConvertFrom-Json).runners
            $runners | Where-Object { $_.status -eq "offline" } | ForEach-Object {
                Write-host $_.name
                $id = $_.id
                gh api -X DELETE /repos/$repo/actions/runners/$id
            }
            $resourceGroup = Get-AzResourceGroup -name $resGroup -ErrorAction Ignore
            if ($resourceGroup) {
              Write-Host "Resource Group Exists"
              exit 1
            }
            $resourceGroup = New-AzResourceGroup -Name $resGroup -Location $resLocation -Force

            gh

